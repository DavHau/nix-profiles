#!/bin/bash

set -e

PROVIDER=vbox
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}"  )" && pwd  )"

source ./$DIR/util.sh
source ./$DIR/$PROVIDER.sh

port::reserve() {
    port=$(port::findfree)
    callprovider $1 portforward $2 $3 $port $4
    callprovider $1 set $2 "port/$3" $port

    echo $port
}

actionmenu() {
    action=$(dmenu::ask "Choose action" "->attach ->stop ->run" )

    if [[ ${action} == "->attach"  ]]; then
        port=$(callprovider $PROVIDER get $1 "port/xpra")
        i3::rename "env/$1"
        xpra::attach $port
    elif [[ ${action} == "->run" ]]; then
        port=$(callprovider $PROVIDER get $1 "port/xpra")
        cmd=$(dmenu::ask "command:")
        xpra::control $port start "/var/setuid-wrappers/sudo -u offlinehacker env \"PATH=/var/run/current-system/sw/bin\" $cmd"
    fi
}

vm=$(dmenu::ask "environments" "$(vbox::environments)")

if [ -z $vm ]; then
    exit 0
fi

if vbox::isrunning $vm; then
    actionmenu $vm
else
    port=$(port::reserve $PROVIDER $vm "xpra" 10000)
    port::reserve $PROVIDER $vm "ssh" 22
    callprovider $PROVIDER set $vm "workspace" $(i3::focusedworkspace)
    callprovider $PROVIDER start $vm
fi
