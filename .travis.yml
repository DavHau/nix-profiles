sudo: true
language: generic
dist: bionic
nix: 2.3.3

jobs:
    include:
        - stage: Build
          env: TARGET=images.hyperv-image
        - env: TARGET=images.iso-dev

install:
    - sudo chmod o+rw /dev/kvm
    - curl https://nixos.org/nix/install | sh
    - . /home/travis/.nix-profile/etc/profile.d/nix.sh
    - sudo mkdir -p /etc/nix
    - echo "binary-caches = https://cache.nixos.org https://xtruder-public.cachix.org" | sudo tee -a /etc/nix/nix.conf > /dev/null
    - echo "binary-cache-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= xtruder-public.cachix.org-1:+qG/fM2195QJcE2BXmKC+sS4mX/lQHqwjBH83Rhzl14=" | sudo tee -a /etc/nix/nix.conf > /dev/null
    - echo "system-features = nixos-test benchmark big-parallel kvm" | sudo tee -a /etc/nix/nix.conf > /dev/null
    - echo "experimental-features = nix-command flakes" | sudo tee -a /etc/nix/nix.conf > /dev/null

    - nix-env -iA cachix -f https://cachix.org/api/v1/install
    - cachix use xtruder-public
    - nix-env -f https://github.com/NixOS/nixpkgs/archive/nixos-unstable.tar.gz -iA nixFlakes

script:
    - if [ -n "$CACHIX_SIGNING_KEY" ]; then cachix push xtruder-public --watch-store; fi &
    - nix build .#$TARGET
